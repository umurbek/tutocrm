{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="flex h-[85vh] bg-[#0a1631]/40 border border-white/5 backdrop-blur-xl rounded-[2.5rem] overflow-hidden relative shadow-2xl">
    
    <div id="users-panel" class="w-full md:w-80 border-r border-white/5 bg-[#050b1a]/30 md:block transition-all">
        <div class="p-6 border-b border-white/5">
            <h2 class="text-xl font-black text-white tracking-tighter flex items-center gap-3">
                <i class="fa-solid fa-comments text-indigo-500"></i>
                Messenger
            </h2>
        </div>
        <ul class="overflow-y-auto h-[calc(85vh-5rem)] custom-scrollbar">
            {% for u in users %}
            <li>
                <a href="#" data-user-id="{{ u.id }}" 
                   class="user-link flex items-center p-4 hover:bg-white/[0.03] transition-all group border-b border-white/[0.02]">
                    <div class="relative">
                        <div class="w-12 h-12 rounded-2xl bg-indigo-600/20 border border-indigo-500/20 flex items-center justify-center font-black text-indigo-400">
                            {{ u.username|first|upper }}
                        </div>
                        <div class="absolute bottom-0 right-0 w-3 h-3 bg-emerald-500 border-2 border-[#0a1631] rounded-full"></div>
                    </div>
                    <div class="ml-4">
                        <span class="block text-sm font-bold text-slate-200 group-hover:text-white">{{ u.username }}</span>
                        <span class="text-[10px] text-slate-500 uppercase tracking-widest">Online</span>
                    </div>
                </a>
            </li>
            {% endfor %}
        </ul>
    </div>

    <div id="chat-panel" class="flex-1 flex flex-col hidden md:flex bg-transparent relative">
        <div class="p-5 border-b border-white/5 flex items-center bg-[#0a1631]/60 backdrop-blur-md sticky top-0 z-10">
            <button id="back-btn" class="md:hidden mr-4 text-slate-400 hover:text-white">
                <i class="fa-solid fa-chevron-left text-xl"></i>
            </button>
            <div id="active-user-avatar" class="w-10 h-10 rounded-xl bg-indigo-600 flex items-center justify-center font-black text-white shadow-lg shadow-indigo-500/20">
                <i class="fa-solid fa-user"></i>
            </div>
            <div class="ml-4">
                <h2 id="chat-username" class="font-black text-white tracking-tight">Chatni tanlang</h2>
                <p class="text-[10px] text-emerald-500 font-bold uppercase tracking-widest">Xavfsiz ulanish</p>
            </div>
        </div>

        <div id="chat-box" class="flex-1 p-6 overflow-y-auto space-y-4 custom-scrollbar bg-gradient-to-b from-transparent to-[#050b1a]/20">
            <div class="flex flex-col items-center justify-center h-full opacity-20">
                <i class="fa-solid fa-message text-6xl text-slate-500 mb-4"></i>
                <p class="font-bold text-slate-400 uppercase tracking-widest text-xs">Muloqotni boshlash uchun kontaktni tanlang</p>
            </div>
        </div>

        <div class="p-4 bg-[#0a1631]/80 backdrop-blur-xl border-t border-white/5">
            <div id="preview-area" class="hidden pb-3 px-4 flex gap-3"></div>
            
            <div class="flex items-end gap-3 max-w-5xl mx-auto">
                <div class="flex gap-2 mb-1">
                    <label class="cursor-pointer w-10 h-10 rounded-xl bg-white/5 border border-white/5 flex items-center justify-center text-slate-400 hover:bg-indigo-600 hover:text-white transition-all">
                        <input type="file" id="file-input" class="hidden" multiple>
                        <i class="fa-solid fa-paperclip"></i>
                    </label>
                    <button id="voice-btn" class="w-10 h-10 rounded-xl bg-white/5 border border-white/5 flex items-center justify-center text-slate-400 hover:bg-rose-600 hover:text-white transition-all">
                        <i class="fa-solid fa-microphone" id="mic-icon"></i>
                    </button>
                </div>

                <div class="flex-1 relative">
                    <textarea id="chat-input" rows="1" 
                              class="w-full bg-[#050b1a] border border-white/5 rounded-2xl px-5 py-3 text-white placeholder-slate-600 focus:outline-none focus:ring-2 focus:ring-indigo-500/50 resize-none overflow-hidden"
                              placeholder="Xabar yozing..."></textarea>
                </div>

                <button id="send-btn" class="mb-1 w-12 h-12 rounded-2xl bg-indigo-600 text-white shadow-xl shadow-indigo-500/20 hover:bg-indigo-500 active:scale-90 transition-all flex items-center justify-center">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.05); border-radius: 10px; }
    
    .message-in { animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .recording { animation: pulseRecord 1.5s infinite; color: #ff4757 !important; }
    @keyframes pulseRecord { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
</style>

<script>
    // Dinamik input balandligi
    const chatInput = document.getElementById('chat-input');
    chatInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });

    let activeUserId = null;
    let mediaRecorder;
    let audioChunks = [];

    // Ovozli xabar yozish
    const voiceBtn = document.getElementById('voice-btn');
    const micIcon = document.getElementById('mic-icon');

    voiceBtn.onclick = async () => {
        if (!mediaRecorder || mediaRecorder.state === "inactive") {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/mp3' });
                sendMedia(audioBlob, 'voice.mp3', 'audio');
            };

            mediaRecorder.start();
            micIcon.classList.add('recording');
        } else {
            mediaRecorder.stop();
            micIcon.classList.remove('recording');
        }
    };

    // Fayllarni yuborish funksiyasi
    async function sendMedia(fileOrBlob, fileName, type) {
        if (!activeUserId) return;
        const formData = new FormData();
        formData.append('file', fileOrBlob, fileName);
        formData.append('type', type);

        await fetch(`/chat/${activeUserId}/send/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            body: formData
        });
        loadMessages();
    }

    // Fayl inputi o'zgarganda
    document.getElementById('file-input').onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const type = file.type.startsWith('video') ? 'video' : 'file';
            sendMedia(file, file.name, type);
        }
    };

    // loadMessages funksiyasini yangilash (Xabarlarni formatlash uchun)
    function formatMessage(m) {
        let content = `<p>${m.text}</p>`;
        if (m.file_url) {
            if (m.type === 'audio') {
                content = `<audio controls class="w-full max-w-xs mt-2 invert opacity-80"><source src="${m.file_url}"></audio>`;
            } else if (m.type === 'video') {
                content = `<video controls class="w-full rounded-xl mt-2"><source src="${m.file_url}"></video>`;
            } else if (m.type === 'image') {
                content = `<img src="${m.file_url}" class="max-w-xs rounded-xl mt-2 cursor-pointer hover:scale-105 transition-all">`;
            } else {
                content = `<a href="${m.file_url}" class="flex items-center gap-2 p-2 bg-white/10 rounded-xl mt-2 hover:bg-white/20">
                            <i class="fa-solid fa-file-arrow-down"></i> ${m.file_name}</a>`;
            }
        }
        return content;
    }

    // Qolgan JS mantiqlari (loadMessages, pollMessages va h.k.) avvalgi javobdagidek qoladi, 
    // faqat HTML strukturasi formatMessage() dan foydalanishi kerak.
</script>
{% endblock %}