<!DOCTYPE html>
<html lang="uz" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}TutorCRM{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Maxsus scrollbar va fon ranglari */
        body {
            background-color: #050b1a; /* Deep Dark Blue */
            color: #cbd5e1;
        }
        .glass-header {
            background: rgba(10, 22, 49, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .glass-dropdown {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
    {% block extra_head %}{% endblock %}
</head>
<body class="font-sans antialiased overflow-x-hidden">

    <div class="flex min-h-screen relative">
        {% include 'partials/sidebar.html' %}

        <div class="flex flex-col flex-1 w-full">
            
            <header class="glass-header sticky top-0 z-30 transition-all duration-300">
                <div class="flex justify-between md:justify-end items-center h-16 px-6">
                    
                    <div class="md:hidden">
                        <span class="text-white font-black italic tracking-tighter">Tutor<span class="text-blue-500 font-normal">CRM</span></span>
                    </div>

                    <div class="flex items-center space-x-2 md:space-x-5">
                        
                        <div class="relative">
                            <button id="notifButton" class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-white/5 transition-all text-slate-400 hover:text-blue-400">
                                <i class="fa-solid fa-bell text-lg"></i>
                                {% if unread_count > 0 %}
                                    <span class="absolute top-2 right-2 flex h-2.5 w-2.5">
                                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                                        <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-blue-500"></span>
                                    </span>
                                {% endif %}
                            </button>

                            <div id="notifDropdown" class="hidden absolute right-0 mt-3 w-80 glass-dropdown rounded-2xl shadow-2xl py-3 z-50 overflow-hidden transform transition-all duration-200">
                                <div class="px-4 pb-2 border-b border-white/5 flex justify-between items-center">
                                    <h3 class="text-sm font-bold text-white tracking-wide">Bildirishnomalar</h3>
                                    {% if unread_count > 0 %}<span class="text-[10px] bg-blue-600 text-white px-2 py-0.5 rounded-full">{{ unread_count }} ta yangi</span>{% endif %}
                                </div>
                                
                                <div class="max-h-96 overflow-y-auto">
                                    {% if unread_list %}
                                        {% for notif in unread_list %}
                                            <a href="{% url 'notifications:notification_read' notif.id %}" class="block px-4 py-4 border-b border-white/5 hover:bg-white/5 transition duration-150 group">
                                                <p class="font-bold text-sm text-slate-200 group-hover:text-blue-400">{{ notif.title }}</p>
                                                <p class="text-[10px] text-slate-500 mt-1 uppercase tracking-wider">
                                                    <i class="fa-regular fa-clock mr-1"></i> {{ notif.created_at|date:"H:i / d.m" }}
                                                </p>
                                            </a>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-center py-10 opacity-30">
                                            <i class="fa-solid fa-bell-slash text-3xl mb-2"></i>
                                            <p class="text-xs italic tracking-widest">Hozircha bo'sh</p>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="px-4 pt-3 text-center">
                                    <a href="{% url 'notifications:notification_list' %}" class="text-xs text-blue-400 hover:text-white font-bold transition">Barchasini ko'rish</a>
                                </div>
                            </div>
                        </div>

                        <a href="{% url 'chat:index' %}" class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-white/5 transition-all text-slate-400 hover:text-cyan-400">
                            <i class="fa-solid fa-message text-lg"></i>
                        </a>

                        <div class="relative">
                            <button id="userMenuButton" class="flex items-center p-1.5 rounded-xl hover:bg-white/5 transition-all focus:outline-none group">
                                <div class="relative">
                                    <img src="{{ avatar_url|default:'/static/images/default-avatar.png' }}" class="w-9 h-9 rounded-lg object-cover ring-2 ring-white/10 group-hover:ring-blue-500/50 transition-all" alt="user">
                                    <div class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-emerald-500 border-2 border-[#0a1631] rounded-full"></div>
                                </div>
                                <div class="hidden md:block text-left ml-3 mr-2">
                                    <p class="font-bold text-sm text-white leading-none tracking-tight">{{ request.user.first_name|default:request.user.username }}</p>
                                    <p class="text-slate-500 text-[10px] mt-1 uppercase font-black tracking-widest">{{ request.user.get_role_display|default:"Foydalanuvchi" }}</p>
                                </div>
                                <i class="fa-solid fa-chevron-down text-[10px] text-slate-500 group-hover:text-white transition-colors"></i>
                            </button>

                            <div id="userDropdown" class="hidden absolute right-0 mt-3 w-60 glass-dropdown rounded-2xl shadow-2xl py-2 z-50 transform transition-all duration-200 overflow-hidden">
                                <div class="px-5 py-4 bg-white/[0.03] border-b border-white/5 mb-2">
                                    <p class="text-xs font-black text-blue-500 uppercase tracking-[0.2em] mb-1">E-pochta</p>
                                    <p class="text-sm text-white truncate font-medium">{{ request.user.email }}</p>
                                </div>

                                <a href="{% url 'accounts:profile' %}" class="flex items-center px-5 py-3 text-slate-400 hover:bg-white/5 hover:text-white transition-all mx-2 rounded-xl">
                                    <i class="fa-solid fa-user-gear mr-4 opacity-50"></i> Profil
                                </a>
                                
                                {% if request.user.is_boss or request.user.is_teacher %}
                                    <a href="{% url 'settings:settings' %}" class="flex items-center px-5 py-3 text-slate-400 hover:bg-white/5 hover:text-white transition-all mx-2 rounded-xl">
                                        <i class="fa-solid fa-sliders mr-4 opacity-50"></i> Sozlamalar
                                    </a>
                                {% endif %}

                                <form method="post" action="{% url 'accounts:logout' %}" class="mt-2 pt-2 border-t border-white/5">
                                    {% csrf_token %}
                                    <button type="submit" class="flex items-center w-full px-5 py-3 text-red-400 hover:bg-red-500/10 transition-all">
                                        <i class="fa-solid fa-power-off mr-4 opacity-50 text-sm"></i> <span class="font-bold">Chiqish</span>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <main class="flex-1 p-4 md:p-10">
                {% block content %}{% endblock %}
            </main>

        </div>
    </div>

    <script>
        const setupDropdown = (buttonId, dropdownId) => {
            const btn = document.getElementById(buttonId);
            const menu = document.getElementById(dropdownId);
            if (btn && menu) {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // Boshqa barcha dropdownlarni yopish
                    document.querySelectorAll('.glass-dropdown').forEach(d => {
                        if (d !== menu) d.classList.add('hidden');
                    });
                    menu.classList.toggle('hidden');
                });
            }
        };

        setupDropdown('userMenuButton', 'userDropdown');
        setupDropdown('notifButton', 'notifDropdown');

        // Tashqariga bosganda yopish
        document.addEventListener('click', () => {
            document.querySelectorAll('.glass-dropdown').forEach(d => d.classList.add('hidden'));
        });
    </script>
</body>
</html>